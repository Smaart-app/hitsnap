---
export interface Props {
  article?: any,
  user?: any,
  mode?: "new" | "edit" | "translate",
  onSuccessUrl?: string,
  lang?: string,
}
const {
  article = {},
  user = {},
  mode = "new",
  onSuccessUrl = "/el/blog",
  lang = "el",
} = Astro.props;

const languages = [
  { value: "el", label: "ğŸ‡¬ğŸ‡· Î•Î»Î»Î·Î½Î¹ÎºÎ¬" },
  { value: "en", label: "ğŸ‡¬ğŸ‡§ English" },
  { value: "nl", label: "ğŸ‡³ğŸ‡± Nederlands" },
  { value: "fr", label: "ğŸ‡«ğŸ‡· FranÃ§ais" },
  { value: "de", label: "ğŸ‡©ğŸ‡ª Deutsch" },
];

const hasArticleLang = typeof article.lang === "string" && article.lang !== "" && article.lang !== undefined;
const initial = {
  title: article.title || "",
  slug: article.slug || "",
  excerpt: article.excerpt || "",
  content: article.content || "",
  cover_image: article.cover_image || "",
  lang: hasArticleLang ? article.lang : "", // ÎšÎµÎ½ÏŒ Î±Î½ ÎµÎ¯Î½Î±Î¹ Î½Î­Î¿ Î¬ÏÎ¸ÏÎ¿!
  translation_of: article.translation_of || "",
  published: article.published ? "true" : "false",
  publish_date: article.publish_date?.slice(0, 16) || "",
  user_id: user?.id || "",
  id: article.id || "",
};
---

<!-- === DEBUG SNIPPET: Î•Î¼Ï†Î±Î½Î¯Î¶ÎµÏ„Î±Î¹ Î Î‘ÎÎ©-Î Î‘ÎÎ© === -->
<div style="background: #ffa; padding: 12px; border: 2px solid #da0; font-size:20px; margin-bottom: 8px">
  Î Î¡Î•Î Î•Î™ Î½Î± Î²Î»Î­Ï€ÎµÎ¹Ï‚ Î±Ï…Ï„ÏŒ Ï„Î¿ Î¼Î®Î½Ï…Î¼Î± Ï€Î¬Î½Ï‰ Î±Ï€ÏŒ Ï„Î¿ dropdown Î³Î»ÏÏƒÏƒÎ±Ï‚!<br/>
  <b>Î‘Î½ Î´ÎµÎ½ Ï„Î¿ Î²Î»Î­Ï€ÎµÎ¹Ï‚, Î±Ï…Ï„ÏŒ Ï„Î¿ component Î´ÎµÎ½ renderÎ¬ÏÎµÎ¹!</b>
</div>
<div>
  <label>Î“Î»ÏÏƒÏƒÎ± (test snippet!)</label>
  <select name="lang" required style="font-size: 18px; margin-bottom:8px">
    <option value="" selected>-- Î”Î¹Î¬Î»ÎµÎ¾Îµ Î³Î»ÏÏƒÏƒÎ± --</option>
    <option value="el">ğŸ‡¬ğŸ‡· Î•Î»Î»Î·Î½Î¹ÎºÎ¬</option>
    <option value="en">ğŸ‡¬ğŸ‡§ English</option>
    <option value="nl">ğŸ‡³ğŸ‡± Nederlands</option>
    <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
    <option value="de">ğŸ‡©ğŸ‡ª Deutsch</option>
  </select>
</div>
<!-- === /DEBUG SNIPPET === -->

<!-- DEBUG info Ï€Î¬Î½Ï‰ Î±Ï€ÏŒ Ï„Î· Ï†ÏŒÏÎ¼Î± -->
<div style="background:#ffc; color:#c00; margin-bottom:1rem; padding:8px; font-size:13px;">
  DEBUG user: <b>{JSON.stringify(user)}</b>
  <br/>DEBUG article.lang: <b>{JSON.stringify(article.lang)}</b>
  <br/>DEBUG prop lang: <b>{JSON.stringify(lang)}</b>
  <br/>DEBUG initial.lang (Î¸Î± ÎµÎ¯Î½Î±Î¹ ÎºÎµÎ½ÏŒ ÏƒÎµ Î½Î­Î¿ Î¬ÏÎ¸ÏÎ¿): <b>{JSON.stringify(initial.lang)}</b>
  <br/>DEBUG article: <pre>{JSON.stringify(article, null, 2)}</pre>
</div>

<!-- Hack: Î“ÏÎ¬ÏˆÎµ Ï„Î¿ user_id ÏƒÏ„Î¿ input ÏŒÏ„Î±Î½ Ï†Î¿ÏÏ„ÏÎ½ÎµÎ¹ Î· ÏƒÎµÎ»Î¯Î´Î± -->
<script is:inline>
  window.HITLIFT_USER_ID = "{user && user.id ? user.id : ''}";
  document.addEventListener('DOMContentLoaded', function() {
    var input = document.getElementById('user_id_input');
    if (input && window.HITLIFT_USER_ID) {
      input.value = window.HITLIFT_USER_ID;
      input.setAttribute('value', window.HITLIFT_USER_ID);
    }
  });
</script>

<form
  id="articleForm"
  class="space-y-4"
  method="post"
  action={mode === "edit" ? "/api/update-article" : "/api/save-article"}
>
  <input type="hidden" name="user_id" id="user_id_input" value={initial.user_id} />
  {initial.id && <input type="hidden" name="id" value={initial.id} />}

  <!-- Î Î‘ÎÎ¤Î‘ Î Î‘ÎÎ©-Î Î‘ÎÎ© Ï„Î¿ dropdown Î“Î»ÏÏƒÏƒÎ±Ï‚ -->
  <div>
    <label class="block font-semibold mb-1">Î“Î»ÏÏƒÏƒÎ±</label>
    <select name="lang" required class="w-full border rounded px-3 py-2">
      <option value="" selected={initial.lang === ""}>-- Î”Î¹Î¬Î»ÎµÎ¾Îµ Î³Î»ÏÏƒÏƒÎ± --</option>
      {languages.map(l =>
        <option value={l.value} selected={l.value === initial.lang}>{l.label}</option>
      )}
    </select>
    <p class="text-xs text-gray-600 mt-1">
      Î”Î¹Î¬Î»ÎµÎ¾Îµ Ï„Î· Î³Î»ÏÏƒÏƒÎ± Ï„Î¿Ï… Î¬ÏÎ¸ÏÎ¿Ï… Ï€ÏÎ¹Î½ Ï„Î¿ Î±Ï€Î¿Î¸Î·ÎºÎµÏÏƒÎµÎ¹Ï‚.
    </p>
  </div>

  <div>
    <label class="block font-semibold mb-1">Î¤Î¯Ï„Î»Î¿Ï‚</label>
    <input type="text" name="title" class="w-full border rounded px-3 py-2" value={initial.title} required />
  </div>
  <div>
    <label class="block font-semibold mb-1">Slug (URL)</label>
    <input type="text" name="slug" class="w-full border rounded px-3 py-2" value={initial.slug} required />
  </div>
  <div>
    <label class="block font-semibold mb-1">Î‘Ï€ÏŒÏƒÏ€Î±ÏƒÎ¼Î±</label>
    <textarea name="excerpt" id="excerptInput" class="w-full border rounded px-3 py-2" rows="3">{initial.excerpt}</textarea>
  </div>
  <div>
    <label class="block font-semibold mb-1">Î ÎµÏÎ¹ÎµÏ‡ÏŒÎ¼ÎµÎ½Î¿ (Markdown)</label>
    <textarea name="content" id="markdownInput" class="w-full border rounded font-mono text-sm px-3 py-2" rows="12">{initial.content}</textarea>
  </div>
  <div>
    <label class="block font-semibold mb-1">Î•Î¹ÎºÏŒÎ½Î± Î•Î¾Ï‰Ï†ÏÎ»Î»Î¿Ï… (URL)</label>
    <input type="text" name="cover_image" class="w-full border rounded px-3 py-2" value={initial.cover_image} />
  </div>
  <div>
    <label class="block font-semibold mb-1">UUID Î ÏÏ‰Ï„ÏŒÏ„Ï…Ï€Î¿Ï… Î†ÏÎ¸ÏÎ¿Ï… (Î±Î½ ÎµÎ¯Î½Î±Î¹ Î¼ÎµÏ„Î¬Ï†ÏÎ±ÏƒÎ·)</label>
    <input type="text" name="translation_of" class="w-full border rounded px-3 py-2"
      value={initial.translation_of}
      placeholder="Î†ÏƒÎµ Ï„Î¿ ÎºÎµÎ½ÏŒ Î±Î½ ÎµÎ¯Î½Î±Î¹ Ï€ÏÏ‰Ï„ÏŒÏ„Ï…Ï€Î¿"
    />
    <p class="text-xs text-gray-500 mt-1">
      Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ Î¼ÏŒÎ½Î¿ Î±Î½ Ï„Î¿ Î¬ÏÎ¸ÏÎ¿ ÎµÎ¯Î½Î±Î¹ Î¼ÎµÏ„Î¬Ï†ÏÎ±ÏƒÎ· (uuid ÎµÎ»Î»Î·Î½Î¹ÎºÎ¿Ï/Î¬Î»Î»Î¿Ï… Î¬ÏÎ¸ÏÎ¿Ï…)
    </p>
  </div>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div>
      <label class="block font-semibold mb-1">Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± Î”Î·Î¼Î¿ÏƒÎ¯ÎµÏ…ÏƒÎ·Ï‚</label>
      <input type="datetime-local" name="publish_date" class="w-full border rounded"
        value={initial.publish_date} />
    </div>
    <div>
      <label class="block font-semibold mb-1">ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</label>
      <select name="published" class="w-full border rounded">
        <option value="false" selected={initial.published !== "true"}>ğŸ“ Î ÏÏŒÏ‡ÎµÎ¹ÏÎ¿</option>
        <option value="true" selected={initial.published === "true"}>âœ… Î”Î·Î¼Î¿ÏƒÎ¹ÎµÏ…Î¼Î­Î½Î¿</option>
      </select>
    </div>
  </div>
  <div class="flex gap-4">
    <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded font-semibold hover:bg-green-700 transition">
      ğŸ’¾ Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·
    </button>
    <a href={onSuccessUrl} class="bg-gray-500 text-white px-6 py-2 rounded font-semibold hover:bg-gray-600 transition">
      â† Î‘ÎºÏÏÏ‰ÏƒÎ·
    </a>
  </div>
</form>

<section class="prose prose-zinc dark:prose-invert p-4 border rounded shadow-sm mt-8 max-h-[600px] overflow-auto">
  <h2 class="text-xl font-bold mb-2">Î ÏÎ¿ÎµÏ€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ·</h2>
  <div id="previewImageContainer">
    {initial.cover_image && (
      <img src={initial.cover_image} alt="cover" class="mb-4 rounded shadow max-h-64 w-full object-cover" />
    )}
  </div>
  <!-- Î‘Ï€ÏŒÏƒÏ€Î±ÏƒÎ¼Î± (markdown) -->
  <div id="excerptPreview" class="text-zinc-600 mb-4"></div>
  <!-- Î ÎµÏÎ¹ÎµÏ‡ÏŒÎ¼ÎµÎ½Î¿ (markdown) -->
  <div id="markdownPreview" class="text-sm text-zinc-800 dark:text-zinc-200"></div>
</section>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script is:inline>
  // Hack: Î’Î¬Î¶ÎµÎ¹ Ï„Î¿ user_id ÏƒÏ„Î¿ Ï€ÎµÎ´Î¯Î¿ Î¼Îµ JS (ÏŒÏ‡Î¹ Î¼ÏŒÎ½Î¿ ÏƒÏ„Î¿ render)
  window.HITLIFT_USER_ID = "{user && user.id ? user.id : ''}";
  document.addEventListener('DOMContentLoaded', function() {
    var input = document.getElementById('user_id_input');
    if (input && window.HITLIFT_USER_ID) {
      input.value = window.HITLIFT_USER_ID;
      input.setAttribute('value', window.HITLIFT_USER_ID);
    }
  });

  // Markdown preview Î³Î¹Î± excerpt
  const excerptInput = document.getElementById('excerptInput');
  const excerptPreview = document.getElementById('excerptPreview');
  function renderExcerpt(text, target) {
    if (window.marked) {
      target.innerHTML = window.marked.parse(text || "");
    }
  }
  if (excerptInput && excerptPreview) {
    excerptInput.addEventListener('input', () => renderExcerpt(excerptInput.value, excerptPreview));
    renderExcerpt(excerptInput.value, excerptPreview);
  }

  // Markdown preview Î³Î¹Î± Ï€ÎµÏÎ¹ÎµÏ‡ÏŒÎ¼ÎµÎ½Î¿
  const input = document.getElementById('markdownInput');
  const preview = document.getElementById('markdownPreview');
  function renderMarkdown(text, target) {
    if (window.marked) {
      target.innerHTML = window.marked.parse(text);
    }
  }
  if (input && preview) {
    input.addEventListener('input', () => renderMarkdown(input.value, preview));
    renderMarkdown(input.value, preview);
  }
</script>
