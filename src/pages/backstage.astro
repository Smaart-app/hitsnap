---
import Layout from '../layouts/Layout.astro';
import { supabase } from '../lib/supabaseClient';
import { supabase } from '../lib/supabaseServerClient';

const url = new URL(Astro.request.url);
const tab = url.searchParams.get('tab') ?? 'all';
const isDev = import.meta.env.MODE === 'development';

if (!isDev) {
  const key = url.searchParams.get('key');
  const allowedKey = 'my-secret-key';
  if (key !== allowedKey) {
    return Astro.redirect('/');
  }
}

const { data: articles, error } = await supabase
  .from('articles')
  .select('*')
  .order('created_at', { ascending: false });

const now = new Date().toISOString();
const visible = tab === 'drafts'
  ? articles?.filter(a => !a.published)
  : tab === 'published'
    ? articles?.filter(a => a.published && a.created_at <= now)
    : tab === 'scheduled'
      ? articles?.filter(a => a.published && a.created_at > now)