---
import Layout from '../layouts/Layout.astro';
import { createServerClient } from '@supabase/ssr';

const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;

const { supabase } = createServerClient(supabaseUrl, supabaseAnonKey, {
  cookies: Astro.cookies
});

const url = new URL(Astro.request.url);
const tab = url.searchParams.get('tab') ?? 'all';
const isDev = import.meta.env.MODE === 'development';

if (!isDev) {
  const key = url.searchParams.get('key');
  const allowedKey = 'my-secret-key';
  if (key !== allowedKey) {
    return Astro.redirect('/');
  }
}

const { data: articles, error } = await supabase
  .from('articles')
  .select('*')
  .order('created_at', { ascending: false });

const now = new Date().toISOString();
const visible = tab === 'drafts'
  ? articles?.filter(a => !a.published)
  : tab === 'published'
    ? articles?.filter(a => a.published && a.created_at <= now)
    : tab === 'scheduled'
      ? articles?.filter(a => a.published && a.created_at > now)
      : articles;
---

<Layout>
  <main class="max-w-3xl mx-auto py-12 px-4">
    <h1 class="text-2xl font-bold mb-4">📊 Backstage</h1>
    <p>Υπάρχουν {visible?.length ?? 0} άρθρα στην κατηγορία <strong>{tab}</strong>.</p>
  </main>
</Layout>
