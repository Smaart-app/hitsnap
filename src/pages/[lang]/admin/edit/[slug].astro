---
import Layout from '../../../../layouts/Layout.astro';
import EditorPage from '../../../../components/editor/EditorPage.astro';

// FS-MODE: Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ¼Îµ backend adapter + cookie Î³Î¹Î± auth
import { getBackend } from '@/lib/backend';
import { isFsMode } from '@/lib/isFsMode';

export const prerender = false;

const { slug, lang } = Astro.params as { slug: string; lang: string };
const backend = getBackend();

// --- Auth
let user: { id: string; email?: string } | null = null;

if (isFsMode()) {
  // Î£Îµ FS mode Î¸ÎµÏ‰ÏÎ¿ÏÎ¼Îµ logged-in Î¼ÏŒÎ½Î¿ Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Ï„Î¿ demo cookie
  const fsLogged = Astro.cookies.get('fs-auth')?.value === '1';
  if (!fsLogged) {
    return new Response('ğŸ”’ Î‘Ï€Î±Î¹Ï„ÎµÎ¯Ï„Î±Î¹ ÎµÎ¯ÏƒÎ¿Î´Î¿Ï‚', { status: 401 });
  }
  user = { id: 'demo-user' };
} else {
  const session = await backend.auth.getSession();
  if (!session.userId) {
    return new Response('ğŸ”’ Î‘Ï€Î±Î¹Ï„ÎµÎ¯Ï„Î±Î¹ ÎµÎ¯ÏƒÎ¿Î´Î¿Ï‚', { status: 401 });
  }
  user = { id: session.userId };
}

// --- Î¦Î­ÏÎµ Î¬ÏÎ¸ÏÎ¿ Î¼Î­ÏƒÏ‰ adapter (ÏŒÏ‡Î¹ Supabase)
const fsArticle = await backend.articles.get(slug, lang || 'el');
if (!fsArticle) {
  return new Response(`ğŸ“­ Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ Î¬ÏÎ¸ÏÎ¿ Î¼Îµ slug: ${slug} (${lang})`, { status: 404 });
}

// Î”Î™ÎŸÎ¡Î˜Î©Î£Î— Î—ÎœÎ•Î¡ÎŸÎœÎ—ÎÎ™Î‘Î£ Î³Î¹Î± input type="datetime-local"
function getLocalDatetimeString(dateStr: string | undefined) {
  if (!dateStr) return '';
  if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/.test(dateStr)) return dateStr;
  try {
    const d = new Date(dateStr);
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const da = String(d.getDate()).padStart(2, '0');
    const h = String(d.getHours()).padStart(2, '0');
    const mi = String(d.getMinutes()).padStart(2, '0');
    return `${y}-${m}-${da}T${h}:${mi}`;
  } catch {
    return '';
  }
}

// Map ÏƒÎµ Î£Î§Î—ÎœÎ‘ Ï€Î¿Ï… Ï€ÎµÏÎ¹Î¼Î­Î½ÎµÎ¹ Î¿ Editor ÏƒÎ¿Ï… (ÏŒÏ€Ï‰Ï‚ Ï€ÏÎ¹Î½ Î¼Îµ Supabase)
const fixedArticle = {
  id: fsArticle.id,
  title: fsArticle.title,
  slug: fsArticle.slug,
  excerpt: fsArticle.excerpt ?? '',
  content: fsArticle.body ?? '',
  cover_image: fsArticle.coverImage ?? '',
  lang: fsArticle.language ?? (lang || 'el'),
  // published + publish_date ÏŒÏ€Ï‰Ï‚ Ï„Î± ÎµÎ¯Ï‡ÎµÏ‚:
  // - draft => published: false
  // - published/scheduled => published: true (Î¿ Î±ÎºÏÎ¹Î²Î®Ï‚ Î´Î¹Î±Ï‡Ï‰ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Î³Î¯Î½ÎµÏ„Î±Î¹ Î±Ï€ÏŒ Ï„Î·Î½ Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±)
  published: fsArticle.status !== 'draft',
  publish_date: getLocalDatetimeString(fsArticle.publishDate),
  translation_of: null, // FS mode Î´ÎµÎ½ ÎºÏÎ±Ï„Î¬ group id â€“ Î±Î½ Î¸Î­Î»ÎµÎ¹Ï‚, Ï„Î¿ Ï€ÏÎ¿ÏƒÎ¸Î­Ï„Î¿Ï…Î¼Îµ Î±ÏÎ³ÏŒÏ„ÎµÏÎ±
};
---

<Layout
  title={fixedArticle?.title ? `Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±: ${fixedArticle.title}` : 'Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Î¬ÏÎ¸ÏÎ¿Ï…'}
  lang={lang}
  user={user}
>
  <EditorPage user={user} article={fixedArticle} />
</Layout>
