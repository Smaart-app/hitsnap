---
import Layout from '../../../layouts/Layout.astro';
import Markdown from '../../../components/Markdown.astro';
import { createServerClient } from '@supabase/ssr';

export const prerender = false;

const { slug, lang } = Astro.params;

const supabase = createServerClient(
  import.meta.env.PUBLIC_SUPABASE_URL,
  import.meta.env.PUBLIC_SUPABASE_ANON_KEY,
  { cookies: Astro.cookies }
);

// ğŸ” Î¦Î­ÏÎ½Î¿Ï…Î¼Îµ Ï„Î¿ Î¬ÏÎ¸ÏÎ¿ ÏƒÏ„Î·Î½ Ï„ÏÎ­Ï‡Î¿Ï…ÏƒÎ± Î³Î»ÏÏƒÏƒÎ±
const { data: articles } = await supabase
  .from('articles')
  .select('*')
  .eq('slug', slug)
  .eq('lang', lang)
  .limit(1);

let article = articles?.[0];

// ğŸ” Î‘Î½ Î´ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ, ÏˆÎ¬Î¾Îµ Î¼Î®Ï€Ï‰Ï‚ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÏƒÎµ Î¬Î»Î»Î· Î³Î»ÏÏƒÏƒÎ± ÎºÎ±Î¹ ÎºÎ¬Î½Îµ redirect
if (!article) {
  const altLang = lang === 'el' ? 'en' : 'el';

  const { data: altArticles } = await supabase
    .from('articles')
    .select('slug')
    .eq('slug', slug)
    .eq('lang', altLang)
    .eq('published', true)
    .limit(1);

  const alt = altArticles?.[0];

  if (alt) {
    return Astro.redirect(`/${altLang}/blog/${slug}`, 302);
  }
}

// âœ… Î‘Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ article, Ï†Î­ÏÎ½Î¿Ï…Î¼Îµ ÎºÎ±Î¹ Ï„Î¿ Î±Î½Ï„Î¯ÏƒÏ„Î¿Î¹Ï‡Î¿ ÏƒÎµ Î¬Î»Î»Î· Î³Î»ÏÏƒÏƒÎ± (Î³Î¹Î± Ï„Î¿ ÎºÎ¿Ï…Î¼Ï€Î¯ Î¼ÎµÏ„Î¬Ï†ÏÎ±ÏƒÎ·Ï‚)
let altArticle = null;

if (article) {
  const altLang = lang === 'el' ? 'en' : 'el';

  const { data: altArticles } = await supabase
    .from('articles')
    .select('slug')
    .eq('translation_of', article.translation_of || article.id)
    .eq('lang', altLang)
    .eq('published', true)
    .limit(1);

  altArticle = altArticles?.[0];
}

const hasAltVersion = !!altArticle;

const pageTitle = article?.title ?? 'Unknown Article';
const pageDescription = article?.excerpt ?? 'This article may have been moved or never existed.';
const pageUrl = `https://hitlift.gr/${lang}/blog/${slug}`;
const markdown = article?.content ?? '';
---

<Layout title={pageTitle} lang={lang}>
  <head slot="head">
    <title>{pageTitle}</title>
    <meta name="description" content={pageDescription} />
    <meta property="og:title" content={pageTitle} />
    <meta property="og:description" content={pageDescription} />
    <meta property="og:type" content="article" />
    <meta property="og:url" content={pageUrl} />
    <meta name="language" content={lang === 'el' ? 'Greek' : 'English'} />
  </head>

  {article ? (
    <section class="max-w-3xl mx-auto py-12 px-4">
      <article class="prose prose-zinc dark:prose-invert max-w-none">
        <h1>{article.title}</h1>

        {article.publish_date && (
          <p class="text-sm text-zinc-500">
            {new Date(article.publish_date).toLocaleDateString(lang === "en" ? "en-GB" : "el-GR")}
          </p>
        )}

        {article.cover_image && (
          <img
            src={article.cover_image}
            alt="Cover image"
            class="my-6 max-h-[400px] w-auto max-w-full object-contain rounded-lg shadow"
          />
        )}

        <Markdown content={markdown} />
      </article>

      {hasAltVersion && (
        <div class="text-right mt-10 text-sm">
          <a
            href={`/${lang === 'el' ? 'en' : 'el'}/blog/${altArticle.slug}`}
            class="text-[#50c7c2] hover:underline"
            reloadDocument
          >
            {lang === 'el' ? 'Î”Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿ ÎºÎ±Î¹ ÏƒÏ„Î± Î‘Î³Î³Î»Î¹ÎºÎ¬ â†’' : 'Also available in Greek â†’'}
          </a>
        </div>
      )}

      <div class="mt-12 text-center mb-24">
        <a href={`/${lang}/blog`} class="inline-block text-[#50c7c2] hover:underline">
          â† {lang === 'el' ? 'Î•Ï€Î¹ÏƒÏ„ÏÎ¿Ï†Î® ÏƒÏ„Î± Î¬ÏÎ¸ÏÎ±' : 'Back to blog'}
        </a>
      </div>

      <details class="mt-8 bg-zinc-100 text-xs p-4 rounded shadow text-black">
        <summary class="cursor-pointer">ğŸ›  View raw article data</summary>
        <pre class="overflow-auto whitespace-pre-wrap">{JSON.stringify(article, null, 2)}</pre>
      </details>
    </section>
  ) : (
    <section class="text-center py-24">
      <h1 class="text-4xl font-bold mb-4">404 â€” Article Not Found</h1>
      <p class="text-gray-600 dark:text-gray-400 mb-8">
        {lang === 'el'
          ? 'Î¤Î¿ Î¬ÏÎ¸ÏÎ¿ Î´ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ Î® Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ Î´Î·Î¼Î¿ÏƒÎ¹ÎµÏ…Ï„ÎµÎ¯.'
          : 'This article may have been moved or unpublished.'}
      </p>
      <a
        href={`/${lang}/blog`}
        class="inline-block bg-[#50c7c2] text-white px-6 py-3 rounded-lg shadow hover:bg-[#3db2b0] transition"
      >
        {lang === 'el' ? 'ğŸ  Î•Ï€Î¹ÏƒÏ„ÏÎ¿Ï†Î® ÏƒÏ„Î± Î¬ÏÎ¸ÏÎ±' : 'ğŸ  Back to blog'}
      </a>
    </section>
  )}
</Layout>
