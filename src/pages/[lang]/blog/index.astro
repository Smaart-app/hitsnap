---
import Layout from '../../../layouts/Layout.astro';
import ArticleCard from '../../../components/ArticleCard.jsx';
import { createServerClient } from '@supabase/ssr';

export async function getStaticPaths() {
  return [
    { params: { lang: 'el' } },
    { params: { lang: 'en' } },
  ];
}

const { lang } = Astro.params;

const supabase = createServerClient(
  import.meta.env.PUBLIC_SUPABASE_URL,
  import.meta.env.PUBLIC_SUPABASE_ANON_KEY,
  { cookies: Astro.cookies }
);

// ğŸ“… Scheduler Logic: Î•Î¼Ï†Î±Î½Î¯Î¶Î¿Ï…Î¼Îµ Î¼ÏŒÎ½Î¿ ÏŒÏƒÎ± Î­Ï‡Î¿Ï…Î½ Ï†Ï„Î¬ÏƒÎµÎ¹ ÏƒÏ„Î·Î½ ÏÏÎ± Ï„Î¿Ï…Ï‚
const todayISO = new Date().toISOString();

const { data: articles, error } = await supabase
  .from('articles')
  .select('*')
  .eq('lang', lang)
  .eq('published', true)
  .lte('publish_date', todayISO)
  .order('publish_date', { ascending: false });

function getAltLang(current) {
  if (current === 'el') return 'en';
  if (current === 'en') return 'el';
  return 'en';
}

const pageTitle = lang === 'en' ? 'Articles | Hitlift' : 'Î†ÏÎ¸ÏÎ± | Hitlift';
const pageDesc = lang === 'en'
  ? 'Explore the latest articles from Hitlift.'
  : 'Î”ÎµÏ‚ Ï„Î± Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯Î± Î¬ÏÎ¸ÏÎ± Î±Ï€ÏŒ Ï„Î· Hitlift.';
---

<Layout title={pageTitle} lang={lang}>
  <head slot="head">
    <meta charset="UTF-8" />
    <meta name="description" content={pageDesc} />
    <title>{pageTitle}</title>
  </head>

  <main class="max-w-6xl mx-auto px-4 py-16">
    <h1 class="text-3xl font-bold text-center mb-10">
      {lang === 'en' ? 'Articles' : 'Î†ÏÎ¸ÏÎ±'}
    </h1>

    {articles && articles.length > 0 ? (
      <section class="grid gap-12 grid-cols-1 md:grid-cols-2 lg:grid-cols-3">
        {articles.map((article) => {
          const altLang = getAltLang(lang);
          const translatedSlug = article.slug.replace(`-${lang}`, `-${altLang}`);
          const hasTranslation = true;

          return (
            <div class="space-y-2">
              <ArticleCard
                title={article.title}
                excerpt={article.excerpt}
                image={article.cover_image}
                href={`/${lang}/blog/${article.slug}`}
                lang={lang}
              />
              {hasTranslation && (
                <p class="text-sm text-right">
                  <a
                    href={`/${altLang}/blog/${translatedSlug}`}
                    class="text-[#50c7c2] hover:underline"
                  >
                    {lang === 'el' ? 'Î”ÎµÏ‚ ÎºÎ±Î¹ ÏƒÏ„Î± Î‘Î³Î³Î»Î¹ÎºÎ¬ â†’' : 'View in Greek â†’'}
                  </a>
                </p>
              )}
            </div>
          );
        })}
      </section>
    ) : (
      <p class="text-center text-gray-500 mt-12">
        {lang === 'en'
          ? 'No articles available.'
          : 'Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±ÎºÏŒÎ¼Î· Î¬ÏÎ¸ÏÎ± Ï€ÏÎ¿Ï‚ Ï€ÏÎ¿Î²Î¿Î»Î®.'}
      </p>
    )}
  </main>
</Layout>
