---
import Layout from '../layouts/Layout.astro';
import { createServerClientReadOnly } from '../lib/createServerClient';

export const prerender = false;

const supabase = createServerClientReadOnly(Astro.cookies);

const {
  data: { user },
} = await supabase.auth.getUser();

if (!user) {
  return Astro.redirect('/login');
}

const url = new URL(Astro.request.url);
const tab = url.searchParams.get('tab') ?? 'all';

const { data: articles, error } = await supabase
  .from('articles')
  .select('*')
  .order('publish_date', { ascending: false });

const todayISO = new Date().toISOString();

let visible = [];

if (tab === 'published') {
  visible = articles?.filter((a) => a.published && a.publish_date <= todayISO) ?? [];
} else if (tab === 'scheduled') {
  visible = articles?.filter((a) => a.published && a.publish_date > todayISO) ?? [];
} else if (tab === 'drafts') {
  visible = articles?.filter((a) => !a.published) ?? [];
} else {
  visible = articles ?? [];
}
---

<Layout title="ğŸ“‹ Î Î¯Î½Î±ÎºÎ±Ï‚ Î†ÏÎ¸ÏÏ‰Î½" user={user}>
  <main class="max-w-6xl mx-auto px-6 py-12">
    <div class="flex justify-between items-center mb-8">
      <h1 class="text-3xl font-bold">ğŸ“‹ Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Î†ÏÎ¸ÏÏ‰Î½</h1>
      <a href="/api/logout" class="text-sm text-red-500 hover:underline">Logout</a>
    </div>

    <div class="mb-6 flex gap-4 text-sm">
      <a href="/dashboard" class={tab === 'all' ? 'text-[#50c7c2] font-bold' : 'text-gray-500 hover:text-[#50c7c2]'}>ÎŒÎ»Î±</a>
      <a href="/dashboard?tab=published" class={tab === 'published' ? 'text-[#50c7c2] font-bold' : 'text-gray-500 hover:text-[#50c7c2]'}>Î”Î·Î¼Î¿ÏƒÎ¹ÎµÏ…Î¼Î­Î½Î±</a>
      <a href="/dashboard?tab=scheduled" class={tab === 'scheduled' ? 'text-[#50c7c2] font-bold' : 'text-gray-500 hover:text-[#50c7c2]'}>Î ÏÎ¿Î³ÏÎ±Î¼Î¼Î±Ï„Î¹ÏƒÎ¼Î­Î½Î±</a>
      <a href="/dashboard?tab=drafts" class={tab === 'drafts' ? 'text-[#50c7c2] font-bold' : 'text-gray-500 hover:text-[#50c7c2]'}>Î ÏÏŒÏ‡ÎµÎ¹ÏÎ±</a>
    </div>

    {error ? (
      <p class="text-red-600 font-semibold">âš ï¸ Î£Ï†Î¬Î»Î¼Î±: {error.message}</p>
    ) : visible.length > 0 ? (
      <table class="w-full text-sm border-t border-gray-200">
        <thead class="text-left border-b border-gray-200 bg-zinc-50">
          <tr>
            <th class="py-2 px-2">Slug</th>
            <th class="py-2 px-2">Î¤Î¯Ï„Î»Î¿Ï‚</th>
            <th class="py-2 px-2">Î“Î»ÏÏƒÏƒÎ±</th>
            <th class="py-2 px-2">ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</th>
            <th class="py-2 px-2">Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±</th>
            <th class="py-2 px-2">Î•Î½Î­ÏÎ³ÎµÎ¹ÎµÏ‚</th>
          </tr>
        </thead>
        <tbody>
          {visible.map((article) => {
            const locale = article.lang === 'en' ? 'en-GB' : 'el-GR';
            const formattedDate = article.publish_date
              ? new Date(article.publish_date).toLocaleDateString(locale)
              : 'â€”';

            const isScheduled = article.published && article.publish_date > todayISO;
            const isPublished = article.published && article.publish_date <= todayISO;

            const editUrl = `/admin/editor/${article.slug}`;
            const altLang = article.lang === 'el' ? 'en' : 'el';
            const translateUrl = `/admin/editor/${article.slug}?base_lang=${article.lang}&lang=${altLang}`;

            return (
              <tr class="border-b border-gray-100 hover:bg-gray-50">
                <td class="py-2 px-2 font-mono">{article.slug}</td>
                <td class="py-2 px-2">{article.title}</td>
                <td class="py-2 px-2 uppercase">{article.lang}</td>
                <td class="py-2 px-2">
                  {isScheduled ? (
                    <span class="text-blue-600 font-medium">ğŸ“… Î ÏÎ¿Î³ÏÎ±Î¼Î¼Î±Ï„Î¹ÏƒÎ¼Î­Î½Î¿</span>
                  ) : isPublished ? (
                    <span class="text-green-600 font-medium">âœ“ Î”Î·Î¼Î¿ÏƒÎ¹ÎµÏ…Î¼Î­Î½Î¿</span>
                  ) : (
                    <span class="text-yellow-600 font-medium">âœ Î ÏÏŒÏ‡ÎµÎ¹ÏÎ¿</span>
                  )}
                </td>
                <td class="py-2 px-2">{formattedDate}</td>
                <td class="py-2 px-2 space-x-2">
                  <a href={editUrl} class="text-[#50c7c2] hover:underline text-sm">âœï¸ Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±</a>
                  <a href={translateUrl} class="text-[#777] hover:text-[#50c7c2] hover:underline text-sm">ğŸŒ ÎœÎµÏ„Î¬Ï†ÏÎ±ÏƒÎ·</a>
                </td>
              </tr>
            );
          })}
        </tbody>
      </table>
    ) : (
      <p class="text-gray-500">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î± Î¬ÏÎ¸ÏÎ±.</p>
    )}
  </main>
</Layout>