---
import Layout from '../layouts/Layout.astro';
import { supabase } from '../lib/supabaseClient';

const url = new URL(Astro.request.url);
const tab = url.searchParams.get('tab') ?? 'all';

const { data: articles, error } = await supabase
  .from('articles')
  .select('*')
  .order('created_at', { ascending: false });

const publishedArticles = articles?.filter((a) => a.published) ?? [];
const drafts = articles?.filter((a) => !a.published) ?? [];

let visible = [];

if (tab === 'published') {
  visible = publishedArticles;
} else if (tab === 'drafts') {
  visible = drafts;
} else {
  visible = articles ?? [];
}
---

<Layout title="ğŸ“‹ Î Î¯Î½Î±ÎºÎ±Ï‚ Î†ÏÎ¸ÏÏ‰Î½">
  <main class="max-w-6xl mx-auto px-6 py-12">
    <h1 class="text-3xl font-bold mb-8">ğŸ“‹ ÎŒÎ»Î± Ï„Î± Î†ÏÎ¸ÏÎ±</h1>

    <!-- Tabs -->
    <div class="mb-6 flex gap-4 text-sm font-medium">
      <a href="/dashboard" class={tab === 'all' ? 'underline text-[#50c7c2]' : 'hover:underline'}>
        ÎŒÎ»Î±
      </a>
      <a href="/dashboard?tab=published" class={tab === 'published' ? 'underline text-green-600' : 'hover:underline'}>
        Î”Î·Î¼Î¿ÏƒÎ¹ÎµÏ…Î¼Î­Î½Î±
      </a>
      <a href="/dashboard?tab=drafts" class={tab === 'drafts' ? 'underline text-yellow-600' : 'hover:underline'}>
        Î ÏÏŒÏ‡ÎµÎ¹ÏÎ±
      </a>
    </div>

    {error && (
      <p class="text-red-600 font-medium">âŒ Î£Ï†Î¬Î»Î¼Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ Î¬ÏÎ¸ÏÏ‰Î½: {error.message}</p>
    )}

    {visible.length > 0 ? (
      <table class="w-full table-auto border-collapse text-sm">
        <thead>
          <tr class="bg-zinc-100 dark:bg-zinc-800 text-left">
            <th class="p-3">Î¤Î¯Ï„Î»Î¿Ï‚</th>
            <th class="p-3">Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±</th>
            <th class="p-3">ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</th>
            <th class="p-3">Î•Î½Î­ÏÎ³ÎµÎ¹ÎµÏ‚</th>
          </tr>
        </thead>
        <tbody>
          {visible.map((article) => (
            <tr class="border-b dark:border-zinc-700 hover:bg-zinc-50 dark:hover:bg-zinc-800 transition">
              <td class="p-3">{article.title}</td>
              <td class="p-3">
                {new Date(article.created_at).toLocaleDateString('el-GR')}
              </td>
              <td class="p-3">
                {article.published ? (
                  <span class="text-green-600 font-medium">Î”Î·Î¼Î¿ÏƒÎ¹ÎµÏ…Î¼Î­Î½Î¿</span>
                ) : (
                  <span class="text-yellow-600 font-medium">Î ÏÏŒÏ‡ÎµÎ¹ÏÎ¿</span>
                )}
              </td>
              <td class="p-3 flex gap-3">
                <a href={`/blog/${article.slug}`} class="text-[#50c7c2] hover:underline">Î ÏÎ¿Î²Î¿Î»Î®</a>
                <a href={`/editor?edit=${article.slug}`} class="text-blue-500 hover:underline">Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±</a>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    ) : (
      <p class="text-gray-600">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î¬ÏÎ¸ÏÎ± ÏƒÎµ Î±Ï…Ï„Î® Ï„Î·Î½ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±.</p>
    )}

    <div class="mt-8">
      <a href="/editor" class="text-sm text-[#50c7c2] hover:underline">â• Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î½Î­Î¿Ï… Î¬ÏÎ¸ÏÎ¿Ï…</a>
    </div>
  </main>
</Layout>
