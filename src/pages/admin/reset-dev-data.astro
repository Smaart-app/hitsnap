---
import { createServerClient } from "@/lib/createServerClientAstro"

const supabase = createServerClient(Astro.cookies)
let message = ""

// Έλεγχος σύνδεσης
const {
  data: { user },
} = await supabase.auth.getUser()

if (!user) {
  return new Response(null, {
    status: 302,
    headers: {
      location: "/en/login",
    },
  })
}

// Ενέργειες POST
if (Astro.request.method === "POST") {
  const form = await Astro.request.formData()
  const action = form.get("action")

  if (action === "reset") {
    await supabase.from("articles").delete().neq("id", "")
    message = "Διέγραψαν όλα τα άρθρα."
  }

  if (action === "demo") {
    const now = new Date()
    await supabase.from("articles").insert([
      {
        title: "Moments in Motion",
        slug: "moments-in-motion",
        content: "# Sample Markdown\nA test post with **bold** text.",
        lang: "en",
        image: "/article-images/demo-1.jpg",
        published_at: now.toISOString(),
      },
      {
        title: "Το σπίτι που δεν με χωράει",
        slug: "to-spiti-pou-den-me-xoraei",
        content: "## Ελληνικό δοκιμαστικό άρθρο",
        lang: "el",
        image: "/article-images/demo-2.jpg",
        published_at: now.toISOString(),
      },
      {
        title: "Contrast and Silence",
        slug: "contrast-and-silence",
        content: "_Minimal markdown with a message._",
        lang: "en",
        image: "/article-images/demo-3.jpg",
        published_at: null,
      },
    ])
    message = "Δημιουργήθηκαν 3 demo άρθρα."
  }
}
---

<html>
  <head>
    <meta charset="UTF-8" />
    <title>Reset Dev Data</title>
    <style>
      body {
        font-family: sans-serif;
        padding: 2rem;
        background: #f4f4f4;
        color: #333;
      }

      button {
        margin-right: 1rem;
        padding: 0.5rem 1rem;
        font-size: 1rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      button:first-of-type {
        background: #e53935;
        color: white;
      }

      button:last-of-type {
        background: #43a047;
        color: white;
      }

      p {
        margin-top: 1rem;
        font-weight: bold;
        color: green;
      }
    </style>
  </head>
  <body>
    <h1>Ρύθμιση Supabase Dev Data</h1>
    <form method="POST">
      <button name="action" value="reset">Διέγραψε όλα τα άρθρα</button>
      <button name="action" value="demo">Δημιουργία demo άρθρων</button>
    </form>
    {message && <p>{message}</p>}
  </body>
</html>
