---
import Layout from '../../../layouts/Layout.astro';
import Markdown from '../../../components/Markdown.astro';
import { createServerClientWithCookies } from '../../../lib/createServerClient.ts';

export const prerender = false;

const { slug } = Astro.params;
const supabase = createServerClientWithCookies(Astro.cookies);

const {
  data: { user },
} = await supabase.auth.getUser();

let article = null;
let error = null;

if (user) {
  const { data, error: fetchError } = await supabase
    .from('articles')
    .select('*')
    .eq('slug', slug)
    .eq('user_id', user.id) // âœ… Î¼ÏŒÎ½Î¿ Ï„Î± Î¬ÏÎ¸ÏÎ± ÏƒÎ¿Ï…
    .limit(1);

  article = data?.[0] ?? null;
  error = fetchError;
} else {
  error = { message: 'Not authenticated' };
}

function getStatus(article) {
  if (!article?.published) return 'draft';
  if (new Date(article.publish_date) > new Date()) return 'scheduled';
  return 'published';
}
---

<Layout title={article?.title || 'Preview'}>
  <main class="max-w-3xl mx-auto px-4 py-16">
    {error ? (
      <p class="text-red-600 text-center text-lg font-semibold">
        âš ï¸ Î£Ï†Î¬Î»Î¼Î±: {error.message}
      </p>
    ) : article ? (
      <>
        <h1 class="text-3xl font-bold mb-4">{article.title}</h1>
        <p class="text-zinc-500 text-sm mb-3">
          ğŸ—“ï¸ {new Date(article.publish_date).toLocaleString('el-GR')} | ğŸ·ï¸ {article.lang?.toUpperCase()}
        </p>
        <p class="text-sm font-semibold mb-6">
          ğŸ“Œ ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·:{' '}
          {getStatus(article) === 'draft' && 'ğŸ“ Î ÏÏŒÏ‡ÎµÎ¹ÏÎ¿'}
          {getStatus(article) === 'scheduled' && 'â³ Î ÏÎ¿Î³ÏÎ±Î¼Î¼Î±Ï„Î¹ÏƒÎ¼Î­Î½Î¿'}
          {getStatus(article) === 'published' && 'âœ… Î”Î·Î¼Î¿ÏƒÎ¹ÎµÏ…Î¼Î­Î½Î¿'}
        </p>
        {article.cover_image && (
          <img
            src={article.cover_image}
            alt="Cover"
            class="rounded-lg mb-6 w-full max-h-[400px] object-cover"
          />
        )}
        <Markdown content={article.content} />
      </>
    ) : (
      <p class="text-center text-red-500 font-semibold">âŒ Î¤Î¿ Î¬ÏÎ¸ÏÎ¿ Î´ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ.</p>
    )}
  </main>
</Layout>