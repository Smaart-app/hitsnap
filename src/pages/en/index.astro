---
import Layout from '../../layouts/Layout.astro';
import ArticleCard from '../../components/ArticleCard.jsx';
import { createServerClient } from '@supabase/ssr';

const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
const supabaseKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;

const supabase = createServerClient(supabaseUrl, supabaseKey, {
  cookies: Astro.cookies,
});

const { data: allArticles, error } = await supabase
  .from('articles')
  .select('*')
  .order('publish_date', { ascending: false });

const filteredArticles = allArticles?.filter((article) => {
  const { published, publish_date, lang } = article;
  const isPublished = published === true;
  const isVisible = new Date(publish_date) <= new Date();
  const isEnglish = lang === 'en';
  return isPublished && isVisible && isEnglish;
}) ?? [];
---

<Layout title="Articles | Hitlift">
  <main class="max-w-6xl mx-auto px-4 py-16">
    <h1 class="text-3xl font-bold text-center mb-10">Articles</h1>

    {filteredArticles.length > 0 ? (
      <section class="grid gap-12 grid-cols-1 md:grid-cols-2 lg:grid-cols-3">
        {filteredArticles.map((article) => (
          <ArticleCard
            title={article.title}
            excerpt={article.excerpt}
            image={article.cover_image}
            href={`/blog/${article.slug}`}
          />
        ))}
      </section>
    ) : (
      <p class="text-center text-gray-500 mt-12">
        No articles available yet.
      </p>
    )}
  </main>
</Layout>
